pipeline:
  agent:
    label: "tenjin-pt-test"

  parameters:
    - string:
        name: TEST_ID
        default: "6504"
        description: "Test ID"
    - string:
        name: PROJECT_ID
        default: "224"
        description: "Project ID"
    - string:
        name: SERVER_HOST
        default: "192.168.16.176"
        description: "Server Host/IP"
    - string:
        name: SERVER_PORT
        default: "81"
        description: "Server Port"

  environment:
    CLUSTER_ID: "152"
    CREATED_BY: "admin"
    CREATED_BY_EMAIL: "admin@gmail.com"

  stages:

    - stage: Checkout
      steps:
        - git:
            branch: "main"
            url: "https://github.com/basavarajbasu1998/test_jenkins.git"

    - stage: Initializing Execution
      steps:
        - script: |
            baseUrl="http://${SERVER_HOST}:${SERVER_PORT}"
            response=$(curl -s -X POST "${baseUrl}/api/execution" \
                        -H "accept: */*" \
                        -H "Content-Type: application/json" \
                        -d '{
                              "testId": '"${TEST_ID}"',
                              "clusterId": "'"${CLUSTER_ID}"'",
                              "projectId": "'"${PROJECT_ID}"'",
                              "createdBy": "'"${CREATED_BY}"'",
                              "createdByEmail": "'"${CREATED_BY_EMAIL}"'"
                            }')
            echo "API 1 Response: ${response}"
            EXECUTION_ID=$(echo $response | jq -r '.executionId')
            echo "Execution ID: ${EXECUTION_ID}"
            export EXECUTION_ID

    - stage: Running Execution
      steps:
        - script: |
            baseUrl="http://${SERVER_HOST}:${SERVER_PORT}"
            executionStatus="Running"
            timeout=1800  # 30 minutes in seconds
            elapsed=0
            while [ "$executionStatus" = "Running" ] && [ $elapsed -lt $timeout ]; do
              sleep 10
              elapsed=$((elapsed + 10))
              statusResponse=$(curl -s -X GET "${baseUrl}/api/execution/summary?executionId=${EXECUTION_ID}" \
                                -H "accept: */*" \
                                -H "Content-Type: application/json")
              echo "API 2 Response: ${statusResponse}"
              executionStatus=$(echo $statusResponse | jq -r '.execution.executionStatus // .executionStatus // "Running"')
              echo "Current Execution Status: ${executionStatus}"
            done
            echo "Execution Finished with Status: ${executionStatus}"

    - stage: Preparing Execution Results
      steps:
        - script: |
            baseUrl="http://${SERVER_HOST}:${SERVER_PORT}"
            zipFile="execution_${EXECUTION_ID}_build_${BUILD_NUMBER}.zip"
            curl -s -o ${zipFile} "${baseUrl}/api/zip/${EXECUTION_ID}"
            echo "ZIP file downloaded: ${zipFile} (workspace: $(pwd))"
        - archiveArtifacts:
            artifacts: "execution_${EXECUTION_ID}_build_${BUILD_NUMBER}.zip"
            fingerprint: true

  post:
    success:
      - echo: "Pipeline completed successfully for Jenkins build ${BUILD_NUMBER}!"
    failure:
      - echo: "Pipeline failed for Jenkins build ${BUILD_NUMBER}."
